<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Dashboard Cotizaciones Sanaré & Nomad</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="css/styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div id="login-container" class="login-container">
    <div class="login-card">
      <img src="img/innvida-logo.png" alt="INNVIDA" class="login-logo" />
      <h2 class="login-title">Acceso a Dashboard</h2>
      <p class="login-subtitle">Ingresa con tu usuario y contraseña INNVIDA.</p>
      <form id="login-form">
        <div class="login-form-group">
          <label for="username">Usuario</label>
          <input type="text" id="username" autocomplete="username" required />
        </div>
        <div class="login-form-group">
          <label for="password">Contraseña</label>
          <input type="password" id="password" autocomplete="current-password" required />
        </div>
        <button type="submit" class="btn primary" style="width:100%; margin-top:0.75rem;">Entrar</button>
        <p id="login-error" class="login-error" style="display:none;">Usuario o contraseña incorrectos.</p>
      </form>
      <div class="login-footer">
        <span>INNVIDA</span> · Acceso exclusivo para Víctor, Antonio, Guillermo y Mónica.
      </div>
    </div>
  </div>

  <div id="appContainer" style="display:none;">
  <header class="top-bar">
    <div class="top-bar-title">
      <h1>Dashboard de Cotizaciones</h1>
      <p>Sanaré &amp; Nomad en tiempo real (Firebase)</p>
    </div>
    <div class="top-bar-actions">
      <button id="btnExportCsvResumen" class="btn primary">CSV resumen</button>
      <button id="btnExportCsvDetallado" class="btn secondary">CSV detallado</button>
    </div>
  </header>

  <main class="layout">
    <section class="panel panel-filtros">
      <h2>Filtros</h2>

      <div class="filtros-grid">
        <div class="campo">
          <label>Marca</label>
          <div class="chips">
            <label><input type="checkbox" class="filtro-marca" value="SANARE" checked> Sanaré</label>
            <label><input type="checkbox" class="filtro-marca" value="NOMAD" checked> Nomad</label>
          </div>
        </div>

        <div class="campo">
          <label>Rango de fechas (por fecha de emisión)</label>
          <div class="campo-inline">
            <input type="date" id="filtroFechaInicio">
            <span>a</span>
            <input type="date" id="filtroFechaFin">
          </div>
        </div>

        <div class="campo">
          <label>Estatus 1</label>
          <select id="filtroStatus1" multiple size="4"></select>
          <small>Ctrl + clic para selección múltiple.</small>
        </div>

        <div class="campo">
          <label>Estatus 2</label>
          <select id="filtroStatus2" multiple size="4"></select>
          <small>Ctrl + clic para selección múltiple.</small>
        </div>

        <div class="campo">
          <label>Buscar (folio, paciente, médico, KAM)</label>
          <input type="text" id="filtroTexto" placeholder="Buscar...">
        </div>

        <div class="campo campo-botones">
          <button id="btnLimpiarFiltros" class="btn ghost">Limpiar filtros</button>
        </div>
      </div>
    </section>

    <section class="panel panel-resumen">
      <h2>Resumen</h2>
      <div class="cards-grid">
        <article class="card">
          <h3>Total global</h3>
          <p class="card-total" id="totalGlobal">$0</p>
          <p class="card-subtitle"><span id="totalGlobalCount">0</span> cotizaciones</p>
        </article>

        <article class="card">
          <h3>Total Sanaré</h3>
          <p class="card-total" id="totalSanare">$0</p>
          <p class="card-subtitle"><span id="totalSanareCount">0</span> cotizaciones</p>
        </article>

        <article class="card">
          <h3>Total Nomad</h3>
          <p class="card-total" id="totalNomad">$0</p>
          <p class="card-subtitle"><span id="totalNomadCount">0</span> cotizaciones</p>
        </article>

        <article class="card">
          <h3>Ticket promedio</h3>
          <p class="card-total" id="ticketPromedio">$0</p>
          <p class="card-subtitle">Global / cotización</p>
        </article>
      </div>
    </section>

    <section class="panel panel-tabla">
      <div class="panel-header">
        <h2>Detalle de cotizaciones</h2>
        <span id="contadorFilas" class="badge">0 filas</span>
      </div>

      <div class="tabla-contenedor">
        <table class="tabla" id="tablaCotizaciones">
          <thead>
            <tr>
              <th>Marca</th>
              <th>Folio</th>
              <th>Fecha emisión</th>
              <th>Paciente</th>
              <th>Médico</th>
              <th>KAM</th>
              <th>Aseguradora</th>
              <th>Total</th>
              <th>Teléfono</th>
              <th>Sede</th>
              <th>Estatus 1</th>
              <th>Estatus 2</th>
              <th>Motivo / comentario</th>
            </tr>
          </thead>
          <tbody id="tablaCotizacionesBody"></tbody>
        </table>
      </div>
    </section>

    <section class="panel panel-graficos">
      <h2>Gráficos</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Productividad por KAM</h3>
          <canvas id="chartKams"></canvas>
        </div>
        <div class="chart-card">
          <h3>Cotizaciones por sede (Sanaré)</h3>
          <canvas id="chartSedes"></canvas>
        </div>
        <div class="chart-card">
          <h3>Totales por prueba (Nomad)</h3>
          <canvas id="chartPruebas"></canvas>
        </div>
        <div class="chart-card">
          <h3>Cotizaciones por mes</h3>
          <canvas id="chartMeses"></canvas>
        </div>
        <div class="chart-card">
          <h3>Distribución por estatus 1</h3>
          <canvas id="chartStatus1"></canvas>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <small>Dashboard en tiempo real con Firebase. Ajusta las colecciones en <code>js/main.js</code> si tu nombre es diferente.</small>
  </footer>
  </div>

<script>
    (function() {
      const USERS = [
        { username: "Victor",    password: "innvida2025" },
        { username: "Antonio",   password: "innvida2025" },
        { username: "Guillermo", password: "innvida2025" },
        { username: "Monica",    password: "innvida2025" }
      ];

      function isValidCredentials(user, pass) {
        if (!user || !pass) return false;
        const u = user.trim().toLowerCase();
        return USERS.some(function(item) {
          return item.username.toLowerCase() === u && item.password === pass;
        });
      }

      function showDashboard() {
        var login = document.getElementById("login-container");
        var app   = document.getElementById("appContainer");
        if (login) login.style.display = "none";
        if (app)   app.style.display   = "";
      }

      document.addEventListener("DOMContentLoaded", function() {
        var saved = window.localStorage ? localStorage.getItem("innvidaDashboardUser") : null;
        if (saved) {
          showDashboard();
          return;
        }

        var form  = document.getElementById("login-form");
        if (!form) return;

        form.addEventListener("submit", function(e) {
          e.preventDefault();
          var userInput = document.getElementById("username");
          var passInput = document.getElementById("password");
          var errorElem = document.getElementById("login-error");

          var user = userInput ? userInput.value : "";
          var pass = passInput ? passInput.value : "";

          if (isValidCredentials(user, pass)) {
            if (window.localStorage) {
              localStorage.setItem("innvidaDashboardUser", user);
            }
            showDashboard();
          } else {
            if (errorElem) errorElem.style.display = "block";
          }
        });
      });
    })();
  </script>

  <script type="module" src="js/main.js"></script>
</body>
</html>
